# MultiPlayerNIIES
## Многооконный плеер для синхронного воспроизведения видеофайлов. 
_Player with multi-window interface to play many video files._ 

## Licence
_This repository contains images from Gnome desktop icons pack (https://www.iconspedia.com/pack/gnome-desktop-2042/) with liscense GNU GPL v.2. The rest of this repository is licensed by WTFPL._

## Руководство по эксплуатации

Данное руководство является наиболее актуальным и дополняется в основном синхронно с добавлением/изменением новых возможностей. Однако различия между текущей версией руководства и текущей версией плеера все же могут быть. В любом случае лучше ориентироваться на него, в крайнем случае свяжитесь с разработчиком.

### Основные понятия

##### _Лидер синхронизации_ 

Одно (только одно) окно видеопроигрывателя, которое является основным в процессе синхронизации с другими окнами. Это означает что в других окнах видеопроигрывателя смещение синхронизации **ВСЕГДА** устанавливается относительно лидера синхронизации.

##### _Титры (SRT-титры, титры с данными о времени) и временнЫе метки_

Данные, сопровождающие видео, содержащиеся в файле формата \*.srt. Для каждого отдельного титра в файле srt указывается интервал времени, когда он должен отображаться на видео и текст титра (с форматированием - цветом,шрифтом и проч). 

В принципе могут содержать любую текстовую информацию

Пример титров - одна запись (в файле srt таких записей тысячи

    10  
    00:00:01,161 --> 00:00:01,202 
    {\an9}<font face="Courier New" size="12" color="#ffffff">00;00;00;370  
    </font>

Первая строка - номер титра. Вторая - интервал времени в который он отображается - здесь титр отображается в течение 41 мсек начиная с 1 сек 161 мсек от начала видеофайла. Третья и следующие строки - данные о форматировании и текст. В качестве текста здесь некая **временнАя метка** - _00;00;00;370_ -  в данном случае это метка времени от ПО стенда о времени прошедшем с начала включения записи/старта эксперимента.

В частности титры с временными метками записываются с помощью систем видеорегистрации на стендах (ПО "Интеллект"). В этом случае титры возможно использовать для синхронизации видео. 

##### _Различия синхронизации по титрам и синхронизации по смещению_

Синхронизация по титрам осуществляется автоматически: плеер для каждого видео с титрами считывает титры, преобразует их в формат времени и сравнивает время титров каждого конкретного видео с временем титров лидера синхронизации (если лидер синхронизации не имеет титров - то возникает баг, который скоро исправлю)  

##### _Смещение синхронизации(dt)_

Например, есть 2 видео: VID1 и VID2, начинающиеся в разные моменты. Соответственно событие А на этих видео при их синхронном просмотре с начала будет видно в разные моменты времени. Таким образом для VID2 мы должны установить смещение синхронизации равное dt. В данном плеере смещение синхронизации может задаваться вручную или при наличии титров с временными метками рассчитывается автоматически на основе данных титров. 

![Схема синхронизации по смещению](https://github.com/lvovandrey/MultiPlayerNIIES/blob/Readme-Branch/ReadmeImgs/Shema.jpg)

Смещение синхронизации **ВСЕГДА** устанавливается относительно лидера синхронизации.

##### _Показатели рассинхронизации (для синхронизации по титрам и синхронизации по смещению)_

Показатель рассинхронизации - это величина, показывающая насколько сильно расходится время (с учетом установленных смещений синхронизации) на всех открытых видео в текущий момент времени.

Пример.

Допустим есть 5 открытых видео. 

Видео | Время события А на видео | Смещение синхронизации | Рассинхрон относительно лидера | Рассинхрон от лидера с учетом смещения 
--- | --- | --- | --- |--- 
Видео 1 (лидер синхронизации) | 0:20 |  0:00 |  0:00 |  0:00 
Видео 2 | 0:15 | +0:05 | -0:05 |  0:00 
Видео 3 | 0:35 | -0:20 | +0:15 | -0:05 
Видео 4 | 0:05 | +0:10 | -0:15 | -0:05
Видео 5 | 0:00 | +0:30 | -0:20 | +0:10

Видео 1 является лидером синхронизации, поэтому у него нет смещения синхронизации и ясно что оно само с собой синхронизированно идеально. Событие А наступает на этом видео на 20-й секунде.

Видео 2 включили на 5 сек позже чем Видео 1, поэтому до события А успело пройти не 20, а только 15 секунд. Таким образом рассинхрон относительно лидера составляет -5 сек. Но на Видео 2 точно выставлено смещение синхронизации, поэтому итоговый рассинхрон нивелируется - т.е. составляет 0 сек.

Аналогично для остальных видео итогорвый рассинхрон составляет -5, -5 и +10 секунд. 
Максимальный рассинхрон составляет 10 секунд.

В плеере показатель рассинхрона рассчитывается так: 

+ рассчитываются значения итогового рассинхрона для каждого из видео
+ из полученного перечня выбирается максимальное **по модулю** значение
+ вышеописанная операция проводится около 20 раз в секунду, при этом составляется список из 10 последних значений максимальной по модулю рассинхронизации (методом "скользящего окна")
+ из полученного списка выбирается максимальное значение, которое выводится пользователю.  

##### _Сохраненный файл состояния плеера (файл состояния, xml-файл состояния)_

Это текстовый xml-файл в котором сохраняется информация о всех открытых видеофайлах расположении окон, текущем времени, смещениях синхронизации, и проч. Плеер позволяет сохранять свое состояние, а затем восстанавливать его из файла. Если очень нужно такой xml-файл можно открыть редактором (например, Блокнотом), и изменить.

##### _Конфигурационный файл настроек плеера, настройки плеера_

Настройка плеера отличается от состояния плеера. Это разные вещи. Настройки - это значения параметров плеера по-умолчанию. Все настройки сохраняются в файле _MultiPlayerNIIES.exe.config_, который располагается рядом с исполняемым файлом (_MultiPlayerNIIES.exe_) программы. Этот файл также можно при большой необходимости открыть в текстовом редакторе (например, в Блокноте) и изменять. 

### 1. Интерфейс

![Общий вид интерфейса](https://github.com/lvovandrey/MultiPlayerNIIES/blob/Readme-Branch/ReadmeImgs/Full2.jpg) 

Рисунок 1. Общий вид графического интерфейса плеера

#### 1.1. Панель управления и таймлайн
![Панель управления](https://github.com/lvovandrey/MultiPlayerNIIES/blob/Readme-Branch/ReadmeImgs/TimeLineAndToolPanelNumered.jpg) 

Рисунок 2. Панель управления

1. Таймлайн (шкала времени) с курсором текущего времени. (Связана с текущим лидером синхронизации)
2. Индикатор текущего времени на лидере синхронизации
3. Подстройка грокости звука для всех открытых видеоокон. 
4. Открыть ранее сохраненный файл состояния плеера. При открытии файла состояния все текущие окна будут закрыты.
5. Сохранить файл состояния плеера.
6. Закрыть все видеоокна плеера.
7. Открыть окно настроек видеоплеера. См. п.1.3
8. Воспроизвести/пауза
9. Стоп (пока работает как пауза)
10. Открыть видеофайл/видеофайлы
11. Синхронизация по титрам
12. Синхронизация по смещению
13. Установить текущий рассинхрон как смещения синхронизации.  
14. Включить/выключить автосинхронизацию по титрам + индикатор рассинхрона по титрам.
15. Включить/выключить автосинхронизацию по выставленным смещениям + индикатор рассинхрона по смещениям.
16. Увеличение/уменьшение скорости воспроизведения.
17. Индикатор текущей скорости воспроизведения.
18. Скачок по времени по всем видео вперед/назад.
19. Настройка длины скачка по времени.
20. Открыть связанный файл Excel + индикатор наличия связи с Excel-файлом.
21. Передать в связанный файл Excel текущее время как время начала интервала. 
22. Передать в связанный файл Excel текущее время как время конца интервала. 


#### 1.2. Видеоокно
![Видеоокно](https://github.com/lvovandrey/MultiPlayerNIIES/blob/Readme-Branch/ReadmeImgs/VideoWindowNumered.jpg) 

Рисунок 3. Видеоокно.

1. Свернуть/развернуть/восстановить/закрыть видеоокно.
2. Имя воспроизводимого видеофайла.
3. Текущие титры.
4. Кнопка/индикатор лидера синхронизации. (Если залита синим, значит это видеоокно - лидер синхронизации).
5. Область воспроизведения видео.
6. Показать/скрыть средства управления проигрыванием видео.
7. Показать/скрыть средства синхронизации по смещению.
8. Воспроизведение/пауза.
9. Громкость звука и правее значение текущей громкости звука.
10. Выключить/включить звук на видео.
11. Замедление/ускорение скорости воспроизведения в 2 раза. 
12. Скачок по времени для данного видео (на 100 мсек)
13. Текущее время для данного видео от его начала.
14. Таймлайн (шкала времени) с курсором текущего времени. (Связана только с видео в данном видеоплеере).
15. Текущее значение смещения синхронизации. 
16. Изменить смещение синхронизации для данного видео на -1000 мс/-100/+100/+1000 мсек. (пока не работает, сделаю позже)
17. Слайдер смещения синхронизации (точка 0 по центру)
18. Текущее фактическое смещение от времени лидера синхронизации (при идеальной синхронизации должно совпадать с показателями счетчика 15)
19. Интервал возможного смещения синхронизации 

Примечание: _На лидере синхронизации п. 15-19 не отображаются, т.к. все видео синхронизируются относительно лидера синхронизации. Не синхронизироваться же ему самому с собой._

#### 1.3. Окно настроек видеоплеера

В данном окне представлены значения параметров плеера по умолчанию. Эти значения сохраняются в конфигурационный файл настроек плеера _MultiPlayerNIIES.exe.config_, который располагается рядом с исполняемым файлом (_MultiPlayerNIIES.exe_) программы. На текущий момент в настройках можно изменять:
- медленную скорость воспроизведения
- быструю скорость воспроизведения
- шаг изменения скорости воспроизведения
- громкость по умолчанию в новом видеоокне
- шаг скачка по видео по умолчанию  (см. Рис.2 п.18 и 19)
- отображать полный путь к файлу в шапке плеера/или только имя файла
- видеофайлы открываются при открытии Сохраненного файла состояния плеера (xml-файла) по абсолютному/относительному пути. (подробнее п. 2.9)

#### 1.4. Горячие клавиши

Клавиша | Операция
------- | --------
Пробел  | Воспроизведение/пауза для всех открытых видеоокон        
Q       | Медленная скорость воспроизведения для всех открытых видеоокон         
W       | Нормальная скорость воспроизведения для всех открытых видеоокон (х1)        
E       | Быстрая скорость воспроизведения для всех открытых видеоокон        
S       | Запуск синхронизации по титрам (для видеоокон, в которых есть титры)        
Ctrl+S  | Запуск синхронизации по выставленным смещениям         
Ctrl+←  | Скачок по всем открытым видео назад         
Ctrl+→  | Скачок по всем открытым видео вперед         
Ctrl+↑  | Увеличить скорость воспроизведения всех открытых видео         
Ctrl+↓  | Уменьшить скорость воспроизведения всех открытых видео 

 
### 2. Основные операции

#### 2.1. Добавление видео

Добавить видео можно с помощью кнопки 10 рис.2. В открывшемся диалоговом окне выберите один или несколько видеофайлов. Нажмите "Открыть" и подождите пока все видео не откроются (обычно около 3-10 сек). 

Если до того в видеоплеере не было добавленных видеоокон, лидером синхронизации становится первое по счету добавленное видеоокно. 

#### 2.2. Назначение лидера синхронизации 

Указать что данное окно будет лидером синхронизации можно с помощью кнопки 4 рис.3. У лидера синхронизации данная кнопка подсвечена синим, у остальных окон - она остается серой. После переназначения лидера синхронизации меняется 

Крайне желательно при работе с некоторым перечнем видео выбирать заранее лидера синхронизации

#### 2.3. Навигация по видео

Основной таймлайн (рис.2 п.1) и индикатор времени (рис.2 п.2) привязаны к текущему лидеру синхронизации

Нажав правой клавишей на индикатор текущего времени (рис.2 п.2) можно скопировать текущее время в буфер обмена. 

#### 2.4. Управление громкостью звука

Слайдер (рис.2 п.3) подстройки громкости на панели управления работает так. 

В каждом видео есть отдельный регулятор уровня звука для данного видео (п.9 на рисунке видеоокна - см. ниже). Можно выставить для отдельных окон свои уровни звука, а затем данным регулятором общей подстройки изменить его сразу на всех видео. Примечание:_Рассчитывается величина так. Уровень громкости звука изменяется от 0 до 100. Регулятор в видеоокне изменяет его соответственно от 0 до 100. Подстройка изменяется от 0 до 5. Эти 2 цифры перемножаются друг на друга. Например в окне регулятор в позиции 40, а подстройка в позиции 1,5, итоговый уровень звука будет равен 40*1.5=60. Если получается значение меньше 0 или больше 100 оно срезается на соответствующей цифре._

#### 2.4. Управление скоростью

#### 2.5. Изменение вида видеоокна

Имя видеофайла (рис.3 п.2)  или его часть можно выделить и скопировать. 

Видеоизображение можно зуммировать с помощью колеса прокрутки мыши, а также перетаскивать (наведите курсор мыши на видеоизобажение, зажмите левую клавишу мыши и перетаскивайте).



#### 2.6. Синхронизация видео

Интервал возможного смещения синхронизации (рис.3. п.19) показывает пределы в рамках которых возможна синхронизация. Фактически это масштаб слайдера синхронизации (рис.3 п.17). На рис.3 указан ы пределы смещения от -10 до +10 секунд, т.о. синхронизация этого видео с помощью слайдера сейчас возможна при рассинхроне с лидером не более чем на 10 сек. Если нужна возможность больших смещений нужно данный интервал изменить в большую сторону с помощью органов управления на индикаторе интервала или введя значение времени в данное поле с клавиатуры.

#### 2.7. Работа с режимами автосинхронизации видео

#### 2.8. Работа со связанным Excel-файлом

Нажав правой клавишей на индикатор текущего времени (рис.1 п.2) можно скопировать текущее время в буфер обмена. 

#### 2.9. Сохранение/восстановление состояния плеера




